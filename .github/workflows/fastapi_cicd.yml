name: FastAPI CI/CD - Test & Stable Deployment

# Trigger configuration
on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Generate timestamp for tagging
    - name: Generate timestamp tag
      id: timestamp
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "Generated timestamp: ${TIMESTAMP}"

    # Step 3: Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: rahul4251
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    # Step 4: Build Docker image with test tag
    - name: Build Docker image with test tag
      run: |
        docker build -t rahul4251/fastapi:test_${{ steps.timestamp.outputs.timestamp }} .
        docker build -t rahul4251/fastapi:latest .
        echo "âœ… Built images: test_${{ steps.timestamp.outputs.timestamp }} and latest"

    # Step 5: Push test image to registry
    - name: Push test image
      run: |
        docker push rahul4251/fastapi:test_${{ steps.timestamp.outputs.timestamp }}
        docker push rahul4251/fastapi:latest
        echo "âœ… Pushed test and latest images to registry"

    # Step 6: Setup SSH for server connection
    - name: Setup SSH connection
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        echo "âœ… SSH setup completed"

    # Step 7: Test SSH connection
    - name: Test SSH connection
      run: |
        echo "Testing SSH connection..."
        ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@${{ secrets.SERVER_IP }} "echo 'âœ… SSH connection successful'"

    # Step 8: Deploy and test the test image on port 7999
    - name: Deploy test image for validation
      id: deploy_test
      run: |
        TEST_TAG="test_${{ steps.timestamp.outputs.timestamp }}"
        echo "ğŸš€ Deploying test image: rahul4251/fastapi:${TEST_TAG}"
        
        ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.SERVER_IP }} << 'EOF'
          # Login to Docker Hub on server
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "rahul4251" --password-stdin
          
          # Pull the test image
          echo "ğŸ“¥ Pulling test image..."
          docker pull rahul4251/fastapi:${TEST_TAG}
          
          # Stop any existing test container
          echo "ğŸ›‘ Stopping existing test container..."
          docker stop fastapi-test 2>/dev/null || true
          docker rm fastapi-test 2>/dev/null || true
          
          # Run test container on port 7999
          echo "ğŸš€ Starting test container on port 7999..."
          docker run -d \
            --name fastapi-test \
            --restart no \
            -p 7999:8000 \
            rahul4251/fastapi:${TEST_TAG}
          
          echo "â³ Waiting for test container to start..."
          sleep 10
        EOF

    # Step 9: Validate test container
    - name: Validate test container
      id: validate_test
      run: |
        echo "ğŸ” Validating test container..."
        
        # Check if container is running
        ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'CHECKEOF'
          # Check if container is running
          if ! docker ps --filter "name=fastapi-test" --format "{{.Names}}" | grep -q "fastapi-test"; then
            echo "âŒ Test container is not running"
            echo "ğŸ“‹ Container logs:"
            docker logs fastapi-test 2>/dev/null || echo "No logs available"
            exit 1
          fi
          
          echo "âœ… Test container is running"
          
          # Check container status
          CONTAINER_STATUS=$(docker ps --filter "name=fastapi-test" --format "{{.Status}}")
          echo "ğŸ“Š Container status: ${CONTAINER_STATUS}"
          
          # Simple check - see if container is up for 10 seconds
          echo "â³ Waiting for container to stabilize..."
          sleep 20
          
          # Check if container is still running
          if docker ps --filter "name=fastapi-test" --format "{{.Names}}" | grep -q "fastapi-test"; then
            echo "âœ… Test container is stable"
            exit 0
          else
            echo "âŒ Test container crashed after 10 seconds"
            echo "ğŸ“‹ Container logs:"
            docker logs fastapi-test 2>/dev/null || echo "No logs available"
            exit 1
          fi
        CHECKEOF
        
        # Check if SSH command succeeded
        if [ $? -eq 0 ]; then
          echo "test_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Test container validation passed"
        else
          echo "test_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ Test container validation failed"
          
          # Get detailed logs
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'LOGS'
            echo "=== TEST CONTAINER FAILURE DETAILS ==="
            echo "1. All containers status:"
            docker ps -a
            echo ""
            echo "2. Test container logs (last 30 lines):"
            docker logs fastapi-test --tail 30 2>/dev/null || echo "No logs available"
            echo ""
            echo "3. Test container exit code:"
            docker inspect fastapi-test --format='{{.State.ExitCode}}' 2>/dev/null || echo "Container not found"
         LOGS
          exit 1
        fi

    # Step 10: If test passes, tag as stable and deploy
    - name: Tag as stable and deploy
      if: steps.validate_test.outputs.test_passed == 'true'
      run: |
        TEST_TAG="test_${{ steps.timestamp.outputs.timestamp }}"
        echo "âœ… Test passed! Tagging ${TEST_TAG} as stable..."
        
        ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.SERVER_IP }} << 'EOF'
          # Tag test image as stable
          echo "ğŸ·ï¸  Tagging image as stable..."
          docker tag rahul4251/fastapi:${TEST_TAG} rahul4251/fastapi:stable
          
          # Push stable image to registry
          echo "ğŸ“¤ Pushing stable image to registry..."
          docker push rahul4251/fastapi:stable
          
          # Clean up test container
          echo "ğŸ§¹ Cleaning up test container..."
          docker stop fastapi-test 2>/dev/null || true
          docker rm fastapi-test 2>/dev/null || true
          
          # Go to app directory (where compose.yaml already exists)
          echo "ğŸ“‚ Switching to app directory..."
          cd /root/fastapi
          
          # Pull the new stable image
          echo "ğŸ“¥ Pulling new stable image..."
          docker pull rahul4251/fastapi:stable
          
          # Deploy using existing compose.yaml
          echo "ğŸš€ Deploying with docker compose..."
          docker compose down
          docker compose up -d
          
          # Verify deployment
          echo "ğŸ” Verifying deployment..."
          sleep 5
          
          if docker ps --filter "name=fastapi" --format "{{.Names}}" | grep -q "fastapi"; then
            echo "âœ… Deployment successful!"
            echo "ğŸ“Š Container status:"
            docker ps --filter "name=fastapi" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ“‹ Checking compose logs..."
            docker compose logs
            exit 1
          fi
        EOF

    # Step 11: Clean up test image on server if test fails
    - name: Cleanup on test failure
      if: failure() && steps.deploy_test.outcome == 'success'
      run: |
        echo "ğŸ§¹ Cleaning up after test failure..."
        ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.SERVER_IP }} << 'CLEANUPEOF'
          echo "=== CLEANING UP TEST RESOURCES ==="
          
          # Stop and remove test container
          echo "Stopping test container..."
          docker stop fastapi-test 2>/dev/null || echo "Test container already stopped"
          docker rm fastapi-test 2>/dev/null || echo "Test container already removed"
          
          # Remove test image to save space (optional)
          echo "Removing test image..."
          TEST_TAG="test_${{ steps.timestamp.outputs.timestamp }}"
          docker rmi rahul4251/fastapi:${TEST_TAG} 2>/dev/null || echo "Test image already removed or not found"
          
          echo "âœ… Cleanup completed"
          echo ""
          echo "ğŸ“Š Current production status:"
          docker ps --filter "name=fastapi" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
        CLEANUPEOF

    # Step 12: Final status report
    - name: Deployment status report
      if: always()
      run: |
        echo "=== DEPLOYMENT SUMMARY ==="
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“¦ New stable image: rahul4251/fastapi:stable"
          echo "ğŸ”„ Test image was: rahul4251/fastapi:test_${{ steps.timestamp.outputs.timestamp }}"
          echo "ğŸŒ Production URL: http://${{ secrets.SERVER_IP }}:8069"
        else
          echo "âŒ DEPLOYMENT FAILED!"
          echo "âš ï¸  Production unchanged - still running previous stable version"
          echo "ğŸ” Failed test image: rahul4251/fastapi:test_${{ steps.timestamp.outputs.timestamp }}"
          echo "ğŸ“‹ Check logs above for failure details"
        fi
        echo "â° Timestamp: $(date)"